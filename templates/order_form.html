{% extends 'base.html' %}

{% block content %}
<div class="card">
    <header style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
        <h1>New Order / Quotation</h1>
        <div style="text-align: right;">
            <div id="saveStatus" style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 0.25rem;">Draft
            </div>
            <div style="color: var(--text-muted); font-size: 0.875rem;">
                Date: <span id="orderDate"></span>
            </div>
        </div>
    </header>

    <form id="orderForm">
        <input type="hidden" id="orderId" value="{{ order_id or '' }}">

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <!-- Customer Selection -->
            <div class="form-group">
                <label>Customer</label>
                <input list="customerList" id="customerInput" class="form-control" placeholder="Search Customer..."
                    required onchange="triggerAutoSave()">
                <datalist id="customerList"></datalist>
                <input type="hidden" id="customerId">
            </div>

            <!-- Status Selection -->
            <div class="form-group">
                <label>Status</label>
                <select id="orderStatus" onchange="triggerAutoSave()">
                    <option value="Draft">Draft</option>
                    <option value="Received">Received</option>
                    <option value="Packed">Packed</option>
                    <option value="Out for Delivery">Out for Delivery</option>
                    <option value="Delivered">Delivered</option>
                    <option value="Cancelled">Cancelled</option>
                    <option value="Return">Return</option>
                </select>
            </div>
        </div>

        <!-- Order Items -->
        <div class="table-container" style="margin: 2rem 0;">
            <table id="itemsTable">
                <thead>
                    <tr>
                        <th style="width: 40%;">Product</th>
                        <th style="width: 15%;">Quantity</th>
                        <th style="width: 15%;">Unit Price</th>
                        <th style="width: 15%;">Tax (18%)</th>
                        <th style="width: 15%;">Total</th>
                        <th></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows -->
                </tbody>
            </table>
            <button type="button" class="btn btn-secondary" onclick="addItemRow()"
                style="margin-top: 1rem; width: 100%;">
                <i data-lucide="plus"></i> Add Item
            </button>
        </div>

        <!-- Totals -->
        <div style="display: flex; justify-content: flex-end;">
            <div style="width: 300px; text-align: right;">
                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                    <span>Subtotal:</span>
                    <span id="subtotalDisplay">₹0.00</span>
                </div>
                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between;">
                    <span>Total Tax (18%):</span>
                    <span id="taxDisplay">₹0.00</span>
                </div>
                <div style="margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
                    <span>Delivery Charges:</span>
                    <input type="number" id="deliveryCharges" value="0" style="width: 100px; text-align: right;"
                        onchange="calculateGlobals(); triggerAutoSave()">
                </div>
                <div
                    style="border-top: 2px solid var(--border); padding-top: 1rem; font-weight: 700; font-size: 1.25rem; display: flex; justify-content: space-between;">
                    <span>Grand Total:</span>
                    <span id="grandTotalDisplay">₹0.00</span>
                </div>
            </div>
        </div>

        <div style="display: flex; justify-content: flex-end; gap: 1rem; margin-top: 2rem;">
            <a href="/orders" class="btn btn-secondary">Back</a>
            <button type="submit" class="btn btn-primary" id="saveButton">{{ 'Update Order' if order_id else 'Create
                Order' }}</button>
        </div>
    </form>
</div>

<!-- Product Map (Hidden JS Object) -->
<script>
    let productsMap = {};
    let customersMap = {};

    document.getElementById('orderDate').innerText = new Date().toLocaleDateString();

    async function init() {
        // Load Customers
        const cRes = await fetch('/api/customers');
        const customers = await cRes.json();
        const cList = document.getElementById('customerList');
        customers.forEach(c => {
            const opt = document.createElement('option');
            opt.value = c.name;
            opt.dataset.id = c.id;
            customersMap[c.name] = c;
            cList.appendChild(opt);
        });

        // Add first row if new order
        const existingOrderId = document.getElementById('orderId').value;
        if (existingOrderId) {
            await loadOrderForEdit(existingOrderId);
        } else {
            addItemRow();
        }
    }

    async function loadOrderForEdit(id) {
        try {
            const res = await fetch(`/api/orders/${id}`);
            const order = await res.json();

            document.getElementById('customerId').value = order.customer_id;
            document.getElementById('customerInput').value = order.customer_name;
            document.getElementById('orderStatus').value = order.status;
            document.getElementById('deliveryCharges').value = order.delivery_charges;
            document.getElementById('orderDate').innerText = new Date(order.order_date).toLocaleDateString();
            document.querySelector('h1').textContent = `Edit Order #${order.id}`;

            const tbody = document.querySelector('#itemsTable tbody');
            tbody.innerHTML = '';

            order.items.forEach(item => {
                addItemRow(item);
            });

            calculateGlobals();
        } catch (e) {
            console.error("Error loading order", e);
            alert("Error loading order data");
        }
    }

    function addItemRow(item = null) {
        const tbody = document.querySelector('#itemsTable tbody');
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>
                <div class="autocomplete-container">
                    <input type="text" class="product-input" placeholder="Search Product..." 
                           oninput="debouncedSearch(this)" autocomplete="off" required
                           value="${item ? item.item_name : ''}">
                    <div class="search-results" style="display: none;"></div>
                    <input type="hidden" class="product-id" value="${item ? item.product_id : ''}">
                </div>
            </td>
            <td>
                <input type="number" class="qty-input" value="${item ? item.quantity : 1}" min="1" onchange="updateRow(this)" required>
            </td>
            <td>
                <input type="number" class="price-input" step="0.01" readonly style="background: #f1f5f9;" 
                       value="${item ? item.unit_price : ''}">
            </td>
            <td class="tax-cell">₹0.00</td>
            <td class="total-cell">₹0.00</td>
            <td>
                <button type="button" class="btn btn-danger" style="padding: 0.25rem;" onclick="removeRow(this)">
                    <i data-lucide="trash-2" size="16"></i>
                </button>
            </td>
        `;
        tbody.appendChild(tr);
        lucide.createIcons();
        if (item) updateRow(tr.querySelector('.qty-input'));
    }

    function removeRow(btn) {
        btn.closest('tr').remove();
        calculateGlobals();
        triggerAutoSave();
    }

    let productSearchTimeout;
    function debouncedSearch(input) {
        clearTimeout(productSearchTimeout);
        const query = input.value.trim();
        const container = input.closest('.autocomplete-container');
        const resultsContainer = container.querySelector('.search-results');

        if (query.length < 2) {
            resultsContainer.style.display = 'none';
            return;
        }

        productSearchTimeout = setTimeout(() => searchProducts(query, input), 300);
    }

    async function searchProducts(query, input) {
        const resultsContainer = input.parentElement.querySelector('.search-results');
        try {
            const res = await fetch(`/api/products?search=${encodeURIComponent(query)}&per_page=10`);
            const data = await res.json();
            const products = data.items || [];

            if (products.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">No products found</div>';
            } else {
                resultsContainer.innerHTML = products.map(p => `
                    <div class="search-result-item" onclick="selectProduct(this, ${JSON.stringify(p).replace(/"/g, '&quot;')})">
                        <span class="item-price">₹${p.sale_price}</span>
                        <span class="item-title">${p.item_name}</span>
                        <span class="item-meta">${p.brand} | ${p.category} | ${p.item_code}</span>
                    </div>
                `).join('');
            }
            resultsContainer.style.display = 'block';
        } catch (e) {
            console.error("Search error", e);
        }
    }

    window.selectProduct = function (element, product) {
        const container = element.closest('.autocomplete-container');
        const input = container.querySelector('.product-input');
        const row = element.closest('tr');

        input.value = `${product.item_name}`;
        row.querySelector('.product-id').value = product.id;
        row.querySelector('.price-input').value = product.sale_price;

        container.querySelector('.search-results').style.display = 'none';
        updateRow(input);
        input.setCustomValidity("");
        triggerAutoSave();
    }

    // Close results when clicking outside
    document.addEventListener('click', (e) => {
        if (!e.target.classList.contains('product-input') && !e.target.closest('.search-results')) {
            document.querySelectorAll('.search-results').forEach(el => el.style.display = 'none');
        }
    });

    function updateRow(el) {
        const row = el.closest('tr');
        const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
        const price = parseFloat(row.querySelector('.price-input').value) || 0;

        const sub = qty * price;
        const tax = sub * 0.18;
        const total = sub + tax;

        row.querySelector('.tax-cell').innerText = '₹' + tax.toFixed(2);
        row.querySelector('.total-cell').innerText = '₹' + total.toFixed(2);

        calculateGlobals();
        triggerAutoSave();
    }

    function calculateGlobals() {
        let subtotal = 0;
        let totalTax = 0;

        document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
            const qty = parseFloat(row.querySelector('.qty-input').value) || 0;
            const price = parseFloat(row.querySelector('.price-input').value) || 0;
            const sub = qty * price;

            subtotal += sub;
            totalTax += sub * 0.18;
        });

        const delivery = parseFloat(document.getElementById('deliveryCharges').value) || 0;
        const grandTotal = subtotal + totalTax + delivery;

        document.getElementById('subtotalDisplay').innerText = '₹' + subtotal.toFixed(2);
        document.getElementById('taxDisplay').innerText = '₹' + totalTax.toFixed(2);
        document.getElementById('grandTotalDisplay').innerText = '₹' + grandTotal.toFixed(2);
    }

    document.getElementById('customerInput').addEventListener('change', function () {
        const customer = customersMap[this.value];
        if (customer) {
            document.getElementById('customerId').value = customer.id;
            this.setCustomValidity("");
            triggerAutoSave();
        } else {
            document.getElementById('customerId').value = "";
            // Optional: allow new customer or force selection
        }
    });

    let autoSaveTimeout;
    function triggerAutoSave() {
        const saveStatus = document.getElementById('saveStatus');
        saveStatus.textContent = 'Saving...';

        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(saveOrder, 1500);
    }

    async function saveOrder() {
        const orderId = document.getElementById('orderId').value;
        const customerId = document.getElementById('customerId').value;
        const saveStatus = document.getElementById('saveStatus');

        if (!customerId) {
            saveStatus.textContent = 'Waiting for customer...';
            return;
        }

        const items = [];
        document.querySelectorAll('#itemsTable tbody tr').forEach(row => {
            const productId = row.querySelector('.product-id').value;
            if (productId) {
                const qty = parseFloat(row.querySelector('.qty-input').value);
                const price = parseFloat(row.querySelector('.price-input').value);
                const sub = qty * price;
                const tax = sub * 0.18;

                items.push({
                    product_id: productId,
                    quantity: qty,
                    unit_price: price,
                    tax_amount: tax,
                    line_total: sub + tax
                });
            }
        });

        if (items.length === 0 && !orderId) {
            saveStatus.textContent = 'Waiting for products...';
            return;
        }

        const delivery = parseFloat(document.getElementById('deliveryCharges').value) || 0;

        // Proper recalc for total
        let finalTotal = 0;
        items.forEach(i => finalTotal += i.line_total);
        finalTotal += delivery;

        const payload = {
            customer_id: customerId,
            delivery_charges: delivery,
            total_amount: finalTotal,
            status: document.getElementById('orderStatus').value,
            items: items
        };

        const method = orderId ? 'PUT' : 'POST';
        const url = orderId ? `/api/orders/${orderId}` : '/api/orders';

        try {
            const res = await fetch(url, {
                method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if (res.ok) {
                const json = await res.json();
                if (!orderId && json.id) {
                    document.getElementById('orderId').value = json.id;
                    document.querySelector('h1').textContent = `Order #${json.id}`;
                }
                saveStatus.textContent = 'Last saved at ' + new Date().toLocaleTimeString();
            } else {
                saveStatus.textContent = 'Error saving changes';
            }
        } catch (e) {
            saveStatus.textContent = 'Network error during save';
        }
    }

    document.getElementById('orderForm').onsubmit = async (e) => {
        e.preventDefault();

        const customerId = document.getElementById('customerId').value;
        if (!customerId) {
            alert("Please select a customer before creating the order.");
            document.getElementById('customerInput').focus();
            return;
        }

        saveStatus.textContent = 'Saving final...';
        await saveOrder();

        const orderId = document.getElementById('orderId').value;
        if (orderId) {
            window.location.href = `/orders/${orderId}`;
        } else {
            alert("Error: Order could not be finalized. Please ensure you have added products.");
        }
    };

    init();
</script>
{% endblock %}