{% extends 'base.html' %}

{% block content %}
<header>
    <h1>Orders</h1>
    <a href="/orders/create" class="btn btn-primary">
        <i data-lucide="plus"></i> New Order
    </a>
</header>

<div class="card">
    <div class="table-container">
        <table id="ordersTable">
            <thead>
                <tr>
                    <th>Order ID</th>
                    <th>Customer</th>
                    <th>Date</th>
                    <th>Total</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody><!-- JS --></tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
    async function loadOrders() {
        const res = await fetch('/api/orders');
        const orders = await res.json();
        const tbody = document.querySelector('#ordersTable tbody');

        tbody.innerHTML = orders.map(o => `
            <tr>
                <td>#${o.id}</td>
                <td>
                    <div style="font-weight: 500;">${o.customer_name || 'Walk-in'}</div>
                </td>
                <td>${new Date(o.order_date).toLocaleDateString()}</td>
                <td>â‚¹${o.total_amount.toFixed(2)}</td>
                <td>
                    <span class="badge status-${o.status?.toLowerCase().replace(/ /g, '-')}">
                        ${o.status || 'Received'}
                    </span>
                </td>
                <td>
                    <div style="display: flex; gap: 0.5rem;">
                        <a href="/orders/${o.id}" class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" title="View Invoice">
                            <i data-lucide="eye" size="16"></i>
                        </a>
                        <a href="/orders/${o.id}/edit" class="btn btn-secondary" style="padding: 0.25rem 0.5rem;" title="Edit Order">
                            <i data-lucide="edit-2" size="16"></i>
                        </a>
                        <button onclick="cancelOrder(${o.id})" class="btn btn-danger" style="padding: 0.25rem 0.5rem;" title="Cancel Order">
                            <i data-lucide="x-circle" size="16"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
        lucide.createIcons();
    }

    async function cancelOrder(id) {
        if (!confirm('Are you sure you want to cancel this order?')) return;

        try {
            const res = await fetch(`/api/orders/${id}/status`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: 'Cancelled' })
            });

            if (res.ok) {
                loadOrders();
            } else {
                alert('Error cancelling order');
            }
        } catch (e) {
            console.error(e);
            alert('Network error');
        }
    }
    loadOrders();
</script>
{% endblock %}